<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio - Consultas Médicas</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <img src="https://via.placeholder.com/150x80?text=Logo+Clinica" alt="Logo Clínica">
            </div>
            <nav class="user-nav">
                <span class="user-name">Bienvenido, Dr. Juan Pérez</span>
                <button class="btn-logout">Cerrar Sesión</button>
            </nav>
        </div>
    </header>

    <aside class="sidebar">
        <nav class="main-nav">
            <ul>
                <li class="active"><a href="dashboard.html">Inicio</a></li>
                <li><a href="historial.html">Historial de Citas</a></li>
                <li><a href="agendar.html">Agendar Cita</a></li>
                <li><a href="#">Mi Perfil</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        <h1>Próximas Citas</h1>
        
        <div class="citas-container" id="citasContainer">
            <!-- Las citas se cargarán aquí dinámicamente -->
        </div>
    </main>
    
    <!-- Agrega estos scripts al final del body -->
    <script type="module">
        import { auth, onAuthStateChanged, signOut } from './src/firebase.js';
        import { ConsultaService } from './src/consulta.js';
      
        // Renderizado mejorado
        const renderCitas = (citas) => {
          const container = document.getElementById('citasContainer');
          
          if (!citas || citas.length === 0) {
            container.innerHTML = `
              <div class="no-citas">
                <p>No tienes citas programadas</p>
              </div>
            `;
            return;
          }
      
          container.innerHTML = citas.map(cita => `
            <div class="cita-card" data-id="${cita.id}">
              <div class="cita-header">
                <h3>${cita.especialidad}</h3>
                <span class="cita-status proxima">Próxima</span>
              </div>
              <div class="cita-body">
                <p><strong>Fecha:</strong> ${cita.fecha.toDate().toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}</p>
                <p><strong>Hora:</strong> ${cita.hora || 'Por definir'}</p>
                <p><strong>Doctor:</strong> ${cita.nombre_doctor}</p>
                <p><strong>Ubicación:</strong> ${cita.ubicacion || 'Por asignar'}</p>
                <p><strong>Motivo:</strong> ${cita.motivo}</p>
              </div>
            </div>
          `).join('');
        };
      
        // Carga inicial con manejo de errores
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                console.log("Usuario UID:", user.uid); // Verifica que el UID sea correcto
                const citas = await ConsultaService.listarPorUsuario(user.uid);
                renderCitas(citas);
                } catch (error) {
                console.error("Error detallado:", error);
                // Muestra el error al usuario
                document.getElementById('citasContainer').innerHTML = `
                    <div class="error">
                    <p>Error al cargar citas: ${error.message}</p>
                    </div>
                `;
                }
            } else {
                window.location.href = 'index.html';
            }
            });
      
        // Logout
        document.querySelector('.btn-logout').addEventListener('click', () => {
          signOut(auth).then(() => {
            window.location.href = 'index.html';
          });
        });
      </script>
</body>
</html>
